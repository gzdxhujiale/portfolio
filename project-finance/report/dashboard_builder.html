<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自助图表 - 电商数据中心</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../data.js"></script>
    <style>
        ::-webkit-scrollbar{width:6px;height:6px}
        ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
        .drag-over{background:#e0e7ff !important;border-color:#6366f1 !important}
    </style>
</head>
<body class="bg-[#F8FAFC]">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo } = React;

        // 图标
        const IconWrapper = ({ children, size = 18, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const BarChart = (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></IconWrapper>;
        const LineChartIcon = (p) => <IconWrapper {...p}><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></IconWrapper>;
        const PieChartIcon = (p) => <IconWrapper {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconWrapper>;
        const Table = (p) => <IconWrapper {...p}><path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></IconWrapper>;
        const Hash = (p) => <IconWrapper {...p}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></IconWrapper>;
        const Type = (p) => <IconWrapper {...p}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></IconWrapper>;
        const X = (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const Layers = (p) => <IconWrapper {...p}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></IconWrapper>;
        const Filter = (p) => <IconWrapper {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconWrapper>;
        const AreaChart = (p) => <IconWrapper {...p}><path d="M3 3v18h18"/><path d="M7 12v5h12V8l-5 5-4-4Z"/></IconWrapper>;

        // 字段配置 - 基于新数据结构（客户A/B/C，淘宝/快手/抖音，27个店铺）
        const DIMENSIONS = [
            { id: 'customer', name: '客户', type: 'dimension' },
            { id: 'platform', name: '平台', type: 'dimension' },
            { id: 'shopName', name: '店铺', type: 'dimension' },
            { id: 'department', name: '部门', type: 'dimension' },
            { id: 'month', name: '月份', type: 'dimension' },
        ];

        const MEASURES = [
            { id: 'gmv', name: 'GMV', type: 'measure', agg: 'sum' },
            { id: 'cost', name: '成本', type: 'measure', agg: 'sum' },
            { id: 'profit', name: '利润', type: 'measure', agg: 'sum' },
            { id: 'orders', name: '订单数', type: 'measure', agg: 'sum' },
            { id: 'visitors', name: '访客数', type: 'measure', agg: 'sum' },
            { id: 'conversionRate', name: '转化率', type: 'measure', agg: 'avg' },
        ];

        const CHART_TYPES = [
            { id: 'bar', name: '柱状图', icon: BarChart },
            { id: 'line', name: '折线图', icon: LineChartIcon },
            { id: 'pie', name: '饼图', icon: PieChartIcon },
            { id: 'area', name: '面积图', icon: AreaChart },
            { id: 'table', name: '表格', icon: Table },
        ];

        const COLORS = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

        const App = () => {
            const rawData = window.MOCK_DATA || [];
            const [chartType, setChartType] = useState('bar');
            const [rows, setRows] = useState([]);
            const [values, setValues] = useState([]);
            const [dragItem, setDragItem] = useState(null);
            // 筛选器状态
            const [dimFilters, setDimFilters] = useState({}); // { platform: ['淘宝', '抖音'], customer: ['橘子'] }
            const [measureFilters, setMeasureFilters] = useState({}); // { gmv: { min: 1000, max: 50000 } }

            // 获取维度的所有可选值
            const getDimValues = (dimId) => [...new Set(rawData.map(r => r[dimId]))].sort();

            // 应用筛选后的数据
            const filteredData = useMemo(() => {
                return rawData.filter(row => {
                    // 维度筛选
                    for (const [dimId, selectedVals] of Object.entries(dimFilters)) {
                        if (selectedVals.length > 0 && !selectedVals.includes(row[dimId])) return false;
                    }
                    // 度量筛选
                    for (const [meaId, range] of Object.entries(measureFilters)) {
                        const val = row[meaId];
                        if (range.min !== '' && val < Number(range.min)) return false;
                        if (range.max !== '' && val > Number(range.max)) return false;
                    }
                    return true;
                });
            }, [rawData, dimFilters, measureFilters]);

            // 聚合数据
            const chartData = useMemo(() => {
                if (rows.length === 0 && values.length === 0) return [];
                const groupKey = (row) => rows.map(r => row[r.id]).join('|||');
                const grouped = {};
                filteredData.forEach(row => {
                    const key = groupKey(row);
                    if (!grouped[key]) {
                        grouped[key] = { _count: 0 };
                        rows.forEach(r => grouped[key][r.id] = row[r.id]);
                        values.forEach(v => grouped[key][v.id] = 0);
                    }
                    grouped[key]._count++;
                    values.forEach(v => { grouped[key][v.id] += row[v.id] || 0; });
                });
                return Object.values(grouped).map(g => {
                    const result = { ...g };
                    values.forEach(v => { if (v.agg === 'avg') result[v.id] = g[v.id] / g._count; });
                    return result;
                }).sort((a, b) => rows.length > 0 ? String(a[rows[0].id]).localeCompare(String(b[rows[0].id])) : 0);
            }, [filteredData, rows, values]);

            const formatNum = (n) => {
                if (n === undefined || n === null) return '-';
                if (Math.abs(n) >= 10000) return (n / 10000).toFixed(1) + '万';
                return n.toLocaleString();
            };

            const handleDragStart = (e, item) => { setDragItem(item); e.dataTransfer.setData('text/plain', JSON.stringify(item)); };
            const handleDrop = (e, target) => {
                e.preventDefault(); e.currentTarget.classList.remove('drag-over');
                let item = dragItem;
                if (!item) try { item = JSON.parse(e.dataTransfer.getData('text/plain')); } catch {}
                if (!item) return;
                if (target === 'rows' && item.type === 'dimension' && !rows.find(r => r.id === item.id)) setRows([...rows, item]);
                if (target === 'values' && item.type === 'measure' && !values.find(v => v.id === item.id)) setValues([...values, item]);
                setDragItem(null);
            };
            const handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); };
            const handleDragLeave = (e) => { e.currentTarget.classList.remove('drag-over'); };
            const removeFromShelf = (shelf, id) => {
                if (shelf === 'rows') { setRows(rows.filter(r => r.id !== id)); setDimFilters(f => { const nf = {...f}; delete nf[id]; return nf; }); }
                if (shelf === 'values') { setValues(values.filter(v => v.id !== id)); setMeasureFilters(f => { const nf = {...f}; delete nf[id]; return nf; }); }
            };

            // 维度筛选器切换
            const toggleDimFilter = (dimId, val) => {
                setDimFilters(prev => {
                    const curr = prev[dimId] || [];
                    const newVals = curr.includes(val) ? curr.filter(v => v !== val) : [...curr, val];
                    return { ...prev, [dimId]: newVals };
                });
            };
            // 度量筛选器更新
            const updateMeasureFilter = (meaId, field, val) => {
                setMeasureFilters(prev => ({ ...prev, [meaId]: { ...(prev[meaId] || { min: '', max: '' }), [field]: val } }));
            };

            // 生成组合标签（如：客户A-淘宝）
            const getLabel = (item) => rows.map(r => item[r.id]).join('-');

            // 渲染图表
            const renderChart = () => {
                if (chartData.length === 0 || values.length === 0) {
                    return (<div className="h-full flex items-center justify-center text-slate-400"><div className="text-center"><Layers size={48} className="mx-auto mb-4 opacity-30" /><p>将维度拖到「行」，度量拖到「值」开始分析</p></div></div>);
                }
                const valueKey = values[0]?.id;
                const maxVal = Math.max(...chartData.map(d => Math.abs(d[valueKey] || 0)), 1);

                if (chartType === 'table') {
                    return (<div className="overflow-auto max-h-full"><table className="w-full text-sm"><thead className="bg-slate-50 sticky top-0"><tr>{rows.map(r => <th key={r.id} className="px-4 py-3 text-left font-medium text-slate-600">{r.name}</th>)}{values.map(v => <th key={v.id} className="px-4 py-3 text-right font-medium text-slate-600">{v.name}</th>)}</tr></thead><tbody>{chartData.slice(0, 100).map((row, idx) => (<tr key={idx} className="border-t border-slate-100 hover:bg-slate-50">{rows.map(r => <td key={r.id} className="px-4 py-2 text-slate-700">{row[r.id]}</td>)}{values.map(v => (<td key={v.id} className={`px-4 py-2 text-right font-medium ${v.id === 'profit' && row[v.id] < 0 ? 'text-red-500' : 'text-slate-800'}`}>{formatNum(row[v.id])}</td>))}</tr>))}</tbody></table>{chartData.length > 100 && <div className="p-3 text-center text-xs text-slate-400">显示前100条，共{chartData.length}条</div>}</div>);
                }
                if (chartType === 'pie') {
                    const total = chartData.reduce((s, d) => s + Math.abs(d[valueKey] || 0), 0);
                    let cumulative = 0;
                    return (<div className="h-full flex items-center justify-center gap-8"><svg width="200" height="200" viewBox="0 0 100 100">{chartData.slice(0, 8).map((item, idx) => { const val = Math.abs(item[valueKey] || 0); const label = getLabel(item); const pct = val / total; if (pct < 0.01) return null; const startAngle = cumulative * 360; cumulative += pct; const endAngle = cumulative * 360; const largeArc = pct > 0.5 ? 1 : 0; const startRad = (startAngle - 90) * Math.PI / 180; const endRad = (endAngle - 90) * Math.PI / 180; const x1 = 50 + 40 * Math.cos(startRad); const y1 = 50 + 40 * Math.sin(startRad); const x2 = 50 + 40 * Math.cos(endRad); const y2 = 50 + 40 * Math.sin(endRad); return <path key={idx} d={`M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={COLORS[idx % COLORS.length]} className="hover:opacity-80 cursor-pointer"><title>{label}: {formatNum(val)}</title></path>; })}<circle cx="50" cy="50" r="18" fill="white" /></svg><div className="space-y-2">{chartData.slice(0, 8).map((item, idx) => (<div key={idx} className="flex items-center gap-2 text-sm"><span className="w-3 h-3 rounded" style={{ backgroundColor: COLORS[idx % COLORS.length] }}></span><span className="text-slate-600">{getLabel(item)}</span><span className="text-slate-800 font-medium ml-auto">{formatNum(item[valueKey])}</span></div>))}</div></div>);
                }
                if (chartType === 'bar') {
                    return (<div className="h-full flex flex-col p-4"><div className="flex-1 flex items-end gap-2 min-h-[280px]">{chartData.slice(0, 20).map((item, idx) => { const val = item[valueKey] || 0; const label = getLabel(item); const h = maxVal > 0 ? (Math.abs(val) / maxVal) * 100 : 0; return (<div key={idx} className="flex-1 flex flex-col items-center min-w-0 h-full justify-end"><div className="text-[10px] text-slate-500 mb-1 truncate w-full text-center">{formatNum(val)}</div><div className={`w-full max-w-[50px] rounded-t transition-all hover:opacity-80 cursor-pointer ${val < 0 ? 'bg-red-400' : ''}`} style={{ height: `${Math.max(h, 2)}%`, minHeight: '4px', backgroundColor: val >= 0 ? COLORS[idx % COLORS.length] : undefined }} title={`${label}: ${formatNum(val)}`}></div><div className="text-[10px] text-slate-500 mt-2 truncate w-full text-center" title={label}>{label}</div></div>); })}</div></div>);
                }
                if (chartType === 'line' || chartType === 'area') {
                    const points = chartData.slice(0, 30).map((d, i) => ({ x: (i / Math.max(chartData.length - 1, 1)) * 90 + 5, y: 85 - ((d[valueKey] || 0) / maxVal) * 70, label: getLabel(d), value: d[valueKey] }));
                    const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                    const areaD = pathD + ` L ${points[points.length-1]?.x || 95} 85 L 5 85 Z`;
                    return (<div className="h-full p-4"><svg className="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">{chartType === 'area' && <path d={areaD} fill={COLORS[0]} fillOpacity="0.2" />}<path d={pathD} fill="none" stroke={COLORS[0]} strokeWidth="0.8" />{points.map((p, i) => (<circle key={i} cx={p.x} cy={p.y} r="1.5" fill={COLORS[0]} className="cursor-pointer"><title>{p.label}: {formatNum(p.value)}</title></circle>))}</svg></div>);
                }
                return <div className="h-full flex items-center justify-center text-slate-400">请选择合适的字段组合</div>;
            };

            const FieldTag = ({ field, onRemove, color = 'indigo' }) => (<div className={`flex items-center gap-1 px-2 py-1 bg-${color}-100 text-${color}-700 rounded text-xs font-medium`}>{field.type === 'dimension' ? <Type size={12} /> : <Hash size={12} />}{field.name}<button onClick={onRemove} className="ml-1 hover:text-red-500"><X size={12} /></button></div>);
            const DropZone = ({ label, items, target, accepts, color = 'slate' }) => (<div className="mb-3"><div className="text-xs font-medium text-slate-500 mb-1">{label}</div><div className={`min-h-[36px] p-2 border-2 border-dashed border-${color}-200 rounded-lg bg-${color}-50/50 flex flex-wrap gap-2 transition-all`} onDrop={(e) => handleDrop(e, target)} onDragOver={handleDragOver} onDragLeave={handleDragLeave}>{items.length === 0 && <span className="text-xs text-slate-400">拖入{accepts}（可多个）</span>}{items.map(item => (<FieldTag key={item.id} field={item} onRemove={() => removeFromShelf(target, item.id)} color={color} />))}</div></div>);

            return (
                <div className="h-screen flex flex-col">
                    <div className="bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center"><Layers size={16} className="text-white" /></div>
                            <div><h1 className="font-bold text-slate-800">自助图表</h1><p className="text-xs text-slate-400">拖拽字段创建可视化分析</p></div>
                        </div>
                        <div className="flex items-center gap-2">
                            {CHART_TYPES.map(ct => (<button key={ct.id} onClick={() => setChartType(ct.id)} title={ct.name} className={`p-2 rounded-lg transition-all ${chartType === ct.id ? 'bg-indigo-100 text-indigo-600' : 'text-slate-400 hover:bg-slate-100 hover:text-slate-600'}`}><ct.icon size={20} /></button>))}
                        </div>
                    </div>
                    <div className="flex-1 flex overflow-hidden">
                        {/* 左侧字段面板 */}
                        <div className="w-52 bg-white border-r border-slate-200 p-4 overflow-y-auto">
                            <div className="mb-5">
                                <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">维度</div>
                                <div className="space-y-1">{DIMENSIONS.map(dim => (<div key={dim.id} draggable onDragStart={(e) => handleDragStart(e, dim)} className="flex items-center gap-2 px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm cursor-grab hover:bg-blue-100 transition-all"><Type size={14} />{dim.name}</div>))}</div>
                            </div>
                            <div>
                                <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">度量</div>
                                <div className="space-y-1">{MEASURES.map(mea => (<div key={mea.id} draggable onDragStart={(e) => handleDragStart(e, mea)} className="flex items-center gap-2 px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm cursor-grab hover:bg-green-100 transition-all"><Hash size={14} />{mea.name}<span className="text-[10px] text-green-500 ml-auto">{mea.agg}</span></div>))}</div>
                            </div>
                        </div>
                        {/* 中间配置区 */}
                        <div className="w-72 bg-slate-50 border-r border-slate-200 p-4 overflow-y-auto">
                            <DropZone label="行 (分组维度)" items={rows} target="rows" accepts="维度" color="blue" />
                            <DropZone label="值 (度量)" items={values} target="values" accepts="度量" color="green" />
                            
                            {/* 维度筛选器 */}
                            {rows.length > 0 && (
                                <div className="mt-4 p-3 bg-white rounded-xl border border-slate-200">
                                    <div className="flex items-center gap-2 text-xs font-medium text-slate-600 mb-2"><Filter size={14} />维度筛选</div>
                                    {rows.map(dim => (
                                        <div key={dim.id} className="mb-3">
                                            <div className="text-xs text-slate-500 mb-1">{dim.name}</div>
                                            <div className="flex flex-wrap gap-1 max-h-24 overflow-y-auto">
                                                {getDimValues(dim.id).map(val => {
                                                    const selected = (dimFilters[dim.id] || []).includes(val);
                                                    return (<button key={val} onClick={() => toggleDimFilter(dim.id, val)} className={`px-2 py-0.5 text-xs rounded transition-all ${selected ? 'bg-blue-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>{val}</button>);
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {/* 度量筛选器 */}
                            {values.length > 0 && (
                                <div className="mt-4 p-3 bg-white rounded-xl border border-slate-200">
                                    <div className="flex items-center gap-2 text-xs font-medium text-slate-600 mb-2"><Filter size={14} />度量筛选</div>
                                    {values.map(mea => (
                                        <div key={mea.id} className="mb-3">
                                            <div className="text-xs text-slate-500 mb-1">{mea.name}</div>
                                            <div className="flex gap-2">
                                                <input type="number" placeholder="最小值" value={measureFilters[mea.id]?.min || ''} onChange={e => updateMeasureFilter(mea.id, 'min', e.target.value)} className="flex-1 px-2 py-1 text-xs border border-slate-200 rounded outline-none focus:border-green-400" />
                                                <input type="number" placeholder="最大值" value={measureFilters[mea.id]?.max || ''} onChange={e => updateMeasureFilter(mea.id, 'max', e.target.value)} className="flex-1 px-2 py-1 text-xs border border-slate-200 rounded outline-none focus:border-green-400" />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            <div className="mt-4 p-3 bg-white rounded-xl border border-slate-200">
                                <div className="text-xs font-medium text-slate-600 mb-2">数据统计</div>
                                <div className="text-xs text-slate-500 space-y-1"><div>原始: {rawData.length} 条</div><div>筛选后: {filteredData.length} 条</div><div>聚合后: {chartData.length} 条</div></div>
                            </div>
                            <button onClick={() => { setRows([]); setValues([]); setDimFilters({}); setMeasureFilters({}); }} className="mt-4 w-full py-2 text-sm text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg transition-all">清空配置</button>
                        </div>
                        {/* 右侧图表区 */}
                        <div className="flex-1 p-6 overflow-hidden"><div className="h-full bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">{renderChart()}</div></div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>