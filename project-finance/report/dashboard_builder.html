<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自助图表 - Tableau风格</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="../data.js"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #f0f0f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 12px; }
        .drag-item { cursor: grab; user-select: none; }
        .drag-item:active { cursor: grabbing; }
        .drop-zone { min-height: 28px; transition: all 0.15s; }
        .drop-zone.drag-over { background: #e3f2fd !important; border-color: #2196f3 !important; }
        .shelf-pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .dim-pill { background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }
        .mea-pill { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
    </style>
</head>
<body class="bg-[#f5f5f5] h-screen overflow-hidden">
    <div id="root" class="h-full"></div>
    <script type="text/babel">
        const { useState, useMemo } = React;

        // 字段配置
        const DIMENSIONS = [
            { id: 'customer', name: '客户', type: 'dimension' },
            { id: 'platform', name: '平台', type: 'dimension' },
            { id: 'shopName', name: '店铺', type: 'dimension' },
            { id: 'department', name: '部门', type: 'dimension' },
        ];
        const MEASURES = [
            { id: 'gmv', name: 'GMV', type: 'measure', agg: 'sum' },
            { id: 'cost', name: '成本', type: 'measure', agg: 'sum' },
            { id: 'profit', name: '利润', type: 'measure', agg: 'sum' },
            { id: 'orders', name: '订单数', type: 'measure', agg: 'sum' },
            { id: 'visitors', name: '访客数', type: 'measure', agg: 'sum' },
        ];

        const TIME_OPTIONS = [
            { id: 'all', name: '全部' },
            { id: 'Q1', name: 'Q1' },
            { id: 'Q2', name: 'Q2' },
            { id: 'Q3', name: 'Q3' },
        ];
        const TIME_MAP = {
            'all': ['2025-01','2025-02','2025-03','2025-04','2025-05','2025-06','2025-07','2025-08'],
            'Q1': ['2025-01','2025-02','2025-03'],
            'Q2': ['2025-04','2025-05','2025-06'],
            'Q3': ['2025-07','2025-08'],
        };
        const CHART_TYPES = [
            { id: 'bar', name: '条形图' },
            { id: 'line', name: '折线图' },
            { id: 'area', name: '面积图' },
            { id: 'table', name: '表格' },
        ];
        const COLORS = ['#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f', '#edc948', '#b07aa1', '#ff9da7'];

        const App = () => {
            const rawData = window.MOCK_DATA || [];
            const [cols, setCols] = useState([]);  // 列架
            const [rows, setRows] = useState([]);  // 行架
            const [chartType, setChartType] = useState('bar');
            const [timeFilter, setTimeFilter] = useState('all');
            const [filters, setFilters] = useState({});
            const [dragItem, setDragItem] = useState(null);

            // 筛选数据
            const filteredData = useMemo(() => {
                const months = TIME_MAP[timeFilter] || TIME_MAP['all'];
                return rawData.filter(row => {
                    if (!months.includes(row.month)) return false;
                    for (const [key, vals] of Object.entries(filters)) {
                        if (vals.length > 0 && !vals.includes(row[key])) return false;
                    }
                    return true;
                });
            }, [rawData, timeFilter, filters]);

            // 聚合数据
            const chartData = useMemo(() => {
                const dims = cols.filter(f => f.type === 'dimension');
                const meas = [...cols, ...rows].filter(f => f.type === 'measure');
                if (dims.length === 0 && meas.length === 0) return [];
                
                const grouped = {};
                filteredData.forEach(row => {
                    const key = dims.map(d => row[d.id]).join('|||') || 'total';
                    if (!grouped[key]) {
                        grouped[key] = { _label: dims.map(d => row[d.id]).join('-') || '合计', _count: 0 };
                        meas.forEach(m => grouped[key][m.id] = 0);
                    }
                    grouped[key]._count++;
                    meas.forEach(m => grouped[key][m.id] += row[m.id] || 0);
                });
                return Object.values(grouped).sort((a, b) => a._label.localeCompare(b._label));
            }, [filteredData, cols, rows]);

            const formatNum = (n) => {
                if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
                if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
                return n.toLocaleString();
            };

            // 拖拽处理
            const handleDragStart = (e, item) => { setDragItem(item); };
            const handleDrop = (e, target) => {
                e.preventDefault();
                if (!dragItem) return;
                const item = { ...dragItem };
                if (target === 'cols' && !cols.find(c => c.id === item.id)) setCols([...cols, item]);
                if (target === 'rows' && !rows.find(r => r.id === item.id)) setRows([...rows, item]);
                if (target === 'filter' && item.type === 'dimension' && !filters[item.id]) {
                    const vals = [...new Set(rawData.map(r => r[item.id]))];
                    setFilters({ ...filters, [item.id]: vals });
                }
                setDragItem(null);
            };
            const handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); };
            const handleDragLeave = (e) => { e.currentTarget.classList.remove('drag-over'); };
            const handleDropEnd = (e) => { e.currentTarget.classList.remove('drag-over'); };
            const removeFromShelf = (shelf, id) => {
                if (shelf === 'cols') setCols(cols.filter(c => c.id !== id));
                if (shelf === 'rows') setRows(rows.filter(r => r.id !== id));
            };
            const removeFilter = (id) => {
                const newFilters = { ...filters };
                delete newFilters[id];
                setFilters(newFilters);
            };
            const toggleFilterVal = (dimId, val) => {
                const curr = filters[dimId] || [];
                const newVals = curr.includes(val) ? curr.filter(v => v !== val) : [...curr, val];
                setFilters({ ...filters, [dimId]: newVals });
            };

            // 获取度量字段
            const measureField = [...cols, ...rows].find(f => f.type === 'measure');
            const maxVal = measureField ? Math.max(...chartData.map(d => d[measureField.id] || 0), 1) : 1;

            return (
                <div className="h-full flex flex-col">
                    {/* 顶部工具栏 */}
                    <div className="h-9 bg-[#3c4043] flex items-center px-3 gap-4 text-white text-xs shrink-0">
                        <span className="font-medium">Sheet1</span>
                        <div className="flex-1" />
                        <span className="text-gray-400">{filteredData.length} 条记录</span>
                    </div>

                    <div className="flex-1 flex overflow-hidden">
                        {/* 左侧数据面板 */}
                        <div className="w-48 bg-white border-r border-gray-200 flex flex-col shrink-0">
                            <div className="px-3 py-2 border-b border-gray-200 flex items-center justify-between">
                                <span className="text-xs font-medium text-gray-600">数据</span>
                                <span className="text-[10px] text-gray-400">分析</span>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2">
                                {/* 时间筛选 */}
                                <div className="mb-3">
                                    <div className="text-[10px] text-gray-400 mb-1 px-1">时间</div>
                                    <select value={timeFilter} onChange={e => setTimeFilter(e.target.value)} 
                                        className="w-full px-2 py-1 text-xs border border-gray-300 rounded bg-white">
                                        {TIME_OPTIONS.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                    </select>
                                </div>
                                {/* 维度 */}
                                <div className="mb-3">
                                    <div className="text-[10px] text-gray-400 mb-1 px-1">维度</div>
                                    {DIMENSIONS.map(dim => (
                                        <div key={dim.id} draggable onDragStart={e => handleDragStart(e, dim)}
                                            className="drag-item flex items-center gap-1.5 px-2 py-1 text-xs text-gray-700 hover:bg-blue-50 rounded">
                                            <span className="text-blue-500 text-[10px]">Abc</span>
                                            {dim.name}
                                        </div>
                                    ))}
                                </div>
                                {/* 度量 */}
                                <div>
                                    <div className="text-[10px] text-gray-400 mb-1 px-1">度量</div>
                                    {MEASURES.map(mea => (
                                        <div key={mea.id} draggable onDragStart={e => handleDragStart(e, mea)}
                                            className="drag-item flex items-center gap-1.5 px-2 py-1 text-xs text-gray-700 hover:bg-green-50 rounded">
                                            <span className="text-green-600 text-[10px]">#</span>
                                            {mea.name}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* 中间配置区 */}
                        <div className="w-44 bg-[#fafafa] border-r border-gray-200 flex flex-col shrink-0">
                            {/* 筛选器 */}
                            <div className="p-2 border-b border-gray-200">
                                <div className="text-[10px] text-gray-500 mb-1">筛选器</div>
                                <div className="drop-zone min-h-[60px] bg-white border border-dashed border-gray-300 rounded p-1"
                                    onDrop={e => { handleDrop(e, 'filter'); handleDropEnd(e); }}
                                    onDragOver={handleDragOver} onDragLeave={handleDragLeave}>
                                    {Object.keys(filters).length === 0 && (
                                        <div className="text-[10px] text-gray-400 text-center py-2">拖入维度</div>
                                    )}
                                    {Object.entries(filters).map(([dimId, vals]) => {
                                        const dim = DIMENSIONS.find(d => d.id === dimId);
                                        const allVals = [...new Set(rawData.map(r => r[dimId]))];
                                        return (
                                            <div key={dimId} className="mb-2">
                                                <div className="flex items-center justify-between text-[10px] text-gray-600 mb-1">
                                                    <span>{dim?.name}</span>
                                                    <button onClick={() => removeFilter(dimId)} className="text-gray-400 hover:text-red-500">×</button>
                                                </div>
                                                <div className="flex flex-wrap gap-1">
                                                    {allVals.map(v => (
                                                        <button key={v} onClick={() => toggleFilterVal(dimId, v)}
                                                            className={`px-1.5 py-0.5 text-[10px] rounded ${vals.includes(v) ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'}`}>
                                                            {v}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            {/* 标记卡 */}
                            <div className="p-2 flex-1">
                                <div className="text-[10px] text-gray-500 mb-1">标记</div>
                                <div className="bg-white border border-gray-200 rounded p-2">
                                    <select value={chartType} onChange={e => setChartType(e.target.value)}
                                        className="w-full px-2 py-1 text-xs border border-gray-300 rounded mb-2">
                                        {CHART_TYPES.map(ct => <option key={ct.id} value={ct.id}>{ct.name}</option>)}
                                    </select>
                                    <div className="grid grid-cols-3 gap-1 text-[10px] text-gray-500">
                                        <div className="text-center p-1 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">颜色</div>
                                        <div className="text-center p-1 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">大小</div>
                                        <div className="text-center p-1 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">标签</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 右侧主区域 */}
                        <div className="flex-1 flex flex-col bg-white overflow-hidden">
                            {/* 列架 */}
                            <div className="flex items-center border-b border-gray-200 px-3 py-1 bg-[#fafafa]">
                                <span className="text-[10px] text-gray-500 w-8 shrink-0">列</span>
                                <div className="drop-zone flex-1 flex flex-wrap gap-1 min-h-[28px] px-2 py-1 bg-white border border-gray-200 rounded"
                                    onDrop={e => { handleDrop(e, 'cols'); handleDropEnd(e); }}
                                    onDragOver={handleDragOver} onDragLeave={handleDragLeave}>
                                    {cols.map(f => (
                                        <span key={f.id} className={`shelf-pill ${f.type === 'dimension' ? 'dim-pill' : 'mea-pill'}`}>
                                            {f.type === 'measure' ? `总和(${f.name})` : f.name}
                                            <button onClick={() => removeFromShelf('cols', f.id)} className="ml-1 hover:text-red-500">×</button>
                                        </span>
                                    ))}
                                </div>
                            </div>
                            {/* 行架 */}
                            <div className="flex items-center border-b border-gray-200 px-3 py-1 bg-[#fafafa]">
                                <span className="text-[10px] text-gray-500 w-8 shrink-0">行</span>
                                <div className="drop-zone flex-1 flex flex-wrap gap-1 min-h-[28px] px-2 py-1 bg-white border border-gray-200 rounded"
                                    onDrop={e => { handleDrop(e, 'rows'); handleDropEnd(e); }}
                                    onDragOver={handleDragOver} onDragLeave={handleDragLeave}>
                                    {rows.map(f => (
                                        <span key={f.id} className={`shelf-pill ${f.type === 'dimension' ? 'dim-pill' : 'mea-pill'}`}>
                                            {f.type === 'measure' ? `总和(${f.name})` : f.name}
                                            <button onClick={() => removeFromShelf('rows', f.id)} className="ml-1 hover:text-red-500">×</button>
                                        </span>
                                    ))}
                                </div>
                            </div>

                            {/* 图表区 */}
                            <div className="flex-1 p-4 overflow-auto">
                                {chartData.length === 0 || !measureField ? (
                                    <div className="h-full flex items-center justify-center text-gray-400 text-sm">
                                        将维度拖到「列」，度量拖到「行」开始分析
                                    </div>
                                ) : chartType === 'table' ? (
                                    <table className="w-full text-xs border-collapse">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border border-gray-300 px-3 py-2 text-left">维度</th>
                                                {[...cols, ...rows].filter(f => f.type === 'measure').map(m => (
                                                    <th key={m.id} className="border border-gray-300 px-3 py-2 text-right">{m.name}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {chartData.map((row, i) => (
                                                <tr key={i} className="hover:bg-gray-50">
                                                    <td className="border border-gray-300 px-3 py-1.5">{row._label}</td>
                                                    {[...cols, ...rows].filter(f => f.type === 'measure').map(m => (
                                                        <td key={m.id} className="border border-gray-300 px-3 py-1.5 text-right font-mono">
                                                            {formatNum(row[m.id])}
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                ) : (
                                    <div className="h-full flex">
                                        {/* Y轴 */}
                                        <div className="w-12 flex flex-col justify-between text-[10px] text-gray-500 pr-2 py-4">
                                            <span>{formatNum(maxVal)}</span>
                                            <span>{formatNum(maxVal * 0.75)}</span>
                                            <span>{formatNum(maxVal * 0.5)}</span>
                                            <span>{formatNum(maxVal * 0.25)}</span>
                                            <span>0</span>
                                        </div>
                                        {/* 图表主体 */}
                                        <div className="flex-1 flex flex-col">
                                            <div className="flex-1 flex items-end gap-1 border-l border-b border-gray-300 px-2 pb-1">
                                                {chartData.map((item, idx) => {
                                                    const val = item[measureField.id] || 0;
                                                    const h = (val / maxVal) * 100;
                                                    const color = COLORS[idx % COLORS.length];
                                                    
                                                    if (chartType === 'line' || chartType === 'area') {
                                                        return null; // 简化处理，折线图用SVG
                                                    }
                                                    return (
                                                        <div key={idx} className="flex-1 flex flex-col items-center justify-end h-full group">
                                                            <div className="w-full max-w-[40px] rounded-t transition-all hover:opacity-80"
                                                                style={{ height: `${h}%`, backgroundColor: color, minHeight: '2px' }}
                                                                title={`${item._label}: ${formatNum(val)}`}>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            {/* X轴标签 */}
                                            <div className="flex gap-1 px-2 pt-1">
                                                {chartData.map((item, idx) => (
                                                    <div key={idx} className="flex-1 text-center text-[10px] text-gray-600 truncate" title={item._label}>
                                                        {item._label}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
