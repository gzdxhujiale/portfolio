<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>权限申请 - 权限中心</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../data.js"></script>
    <script>tailwind.config = { theme: { extend: { animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)' }, keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } } } } }</script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        body { overflow-x: hidden; }
    </style>
</head>
<body class="bg-[#F8FAFC]">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo } = React;

        const IconWrapper = ({ children, size = 18, className = "", ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const Send = (p) => <IconWrapper {...p}><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconWrapper>;
        const Plus = (p) => <IconWrapper {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
        const Check = (p) => <IconWrapper {...p}><polyline points="20 6 9 17 4 12"/></IconWrapper>;
        const X = (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const Clock = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>;
        const CheckCircle = (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>;
        const XCircle = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconWrapper>;
        const Eye = (p) => <IconWrapper {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
        const MessageSquare = (p) => <IconWrapper {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconWrapper>;

        // 使用统一数据
        const INITIAL_APPLICATIONS = window.APPLICATIONS || [];
        const ROLES = window.ROLE_NAMES || [];

        const getStatusConfig = (status) => {
            const configs = {
                pending: { label: '待审批', color: 'bg-amber-100 text-amber-700 border-amber-200', icon: Clock },
                approved: { label: '已通过', color: 'bg-green-100 text-green-700 border-green-200', icon: CheckCircle },
                rejected: { label: '已拒绝', color: 'bg-red-100 text-red-700 border-red-200', icon: XCircle },
            };
            return configs[status] || configs.pending;
        };

        const App = () => {
            const [applications, setApplications] = useState(INITIAL_APPLICATIONS);
            const [activeTab, setActiveTab] = useState('pending');
            const [modal, setModal] = useState({ open: false, type: '', data: null });

            const filteredApps = useMemo(() => {
                if (activeTab === 'all') return applications;
                return applications.filter(a => a.status === activeTab);
            }, [applications, activeTab]);

            const pendingCount = applications.filter(a => a.status === 'pending').length;

            const handleApprove = (id, approved, comment) => {
                setApplications(prev => prev.map(a => a.id === id ? {
                    ...a,
                    status: approved ? 'approved' : 'rejected',
                    approver: '当前用户',
                    approveTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    comment: comment
                } : a));
                setModal({ open: false, type: '', data: null });
            };

            const handleNewApplication = (formData) => {
                const newApp = {
                    id: Date.now(),
                    applicant: '当前用户',
                    department: '所属部门',
                    currentRoles: ['业务BI'],
                    requestRoles: formData.requestRoles,
                    reason: formData.reason,
                    status: 'pending',
                    createTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    approver: null,
                    approveTime: null,
                    comment: null
                };
                setApplications(prev => [newApp, ...prev]);
                setModal({ open: false, type: '', data: null });
            };

            return (
                <div className="p-8 max-w-[1400px] mx-auto animate-fade-in">
                    <div className="mb-8 flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-cyan-100 flex items-center justify-center">
                                    <Send size={20} className="text-cyan-600" />
                                </div>
                                权限申请
                            </h2>
                            <p className="text-slate-500 text-sm mt-1 ml-13">提交权限申请、审批权限请求</p>
                        </div>
                        <button onClick={() => setModal({ open: true, type: 'new', data: null })} className="px-5 py-2.5 bg-indigo-600 text-white rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all flex items-center gap-2 text-sm font-medium">
                            <Plus size={18} /> 发起申请
                        </button>
                    </div>

                    {/* 统计卡片 */}
                    <div className="grid grid-cols-4 gap-6 mb-8">
                        <div className="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                            <div className="text-slate-500 text-sm mb-2">全部申请</div>
                            <div className="text-3xl font-bold text-slate-800">{applications.length}</div>
                        </div>
                        <div className="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-6 text-white shadow-lg">
                            <div className="text-amber-100 text-sm mb-2">待审批</div>
                            <div className="text-3xl font-bold">{pendingCount}</div>
                        </div>
                        <div className="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                            <div className="text-slate-500 text-sm mb-2">已通过</div>
                            <div className="text-3xl font-bold text-green-600">{applications.filter(a => a.status === 'approved').length}</div>
                        </div>
                        <div className="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                            <div className="text-slate-500 text-sm mb-2">已拒绝</div>
                            <div className="text-3xl font-bold text-red-600">{applications.filter(a => a.status === 'rejected').length}</div>
                        </div>
                    </div>

                    {/* 主内容 */}
                    <div className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                        {/* Tab 切换 */}
                        <div className="flex border-b border-slate-100">
                            {[
                                { key: 'pending', label: '待审批', count: pendingCount },
                                { key: 'approved', label: '已通过' },
                                { key: 'rejected', label: '已拒绝' },
                                { key: 'all', label: '全部' },
                            ].map(tab => (
                                <button
                                    key={tab.key}
                                    onClick={() => setActiveTab(tab.key)}
                                    className={`px-6 py-4 text-sm font-medium transition-all relative ${activeTab === tab.key ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    {tab.label}
                                    {tab.count > 0 && (
                                        <span className="ml-2 px-1.5 py-0.5 bg-amber-500 text-white text-[10px] rounded-full">{tab.count}</span>
                                    )}
                                </button>
                            ))}
                        </div>

                        {/* 申请列表 */}
                        <div className="divide-y divide-slate-50">
                            {filteredApps.length === 0 ? (
                                <div className="p-20 text-center text-slate-400">
                                    <Send size={48} className="mx-auto mb-4 opacity-30" />
                                    <p>暂无申请记录</p>
                                </div>
                            ) : (
                                filteredApps.map(app => {
                                    const statusConfig = getStatusConfig(app.status);
                                    const StatusIcon = statusConfig.icon;
                                    return (
                                        <div key={app.id} className="p-6 hover:bg-slate-50 transition-colors">
                                            <div className="flex items-start justify-between">
                                                <div className="flex items-start gap-4">
                                                    <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                                                        {app.applicant[0]}
                                                    </div>
                                                    <div>
                                                        <div className="flex items-center gap-3 mb-1">
                                                            <span className="font-bold text-slate-800">{app.applicant}</span>
                                                            <span className="text-xs text-slate-400">{app.department}</span>
                                                            <span className={`px-2 py-0.5 rounded text-xs font-medium border flex items-center gap-1 ${statusConfig.color}`}>
                                                                <StatusIcon size={12} />
                                                                {statusConfig.label}
                                                            </span>
                                                        </div>
                                                        <div className="text-sm text-slate-600 mb-2">
                                                            申请角色：
                                                            {app.requestRoles.map(role => (
                                                                <span key={role} className="ml-1 px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-medium">{role}</span>
                                                            ))}
                                                        </div>
                                                        <div className="text-sm text-slate-500 mb-2">
                                                            <span className="text-slate-400">申请理由：</span>{app.reason}
                                                        </div>
                                                        <div className="flex items-center gap-4 text-xs text-slate-400">
                                                            <span>申请时间：{app.createTime}</span>
                                                            {app.approver && <span>审批人：{app.approver}</span>}
                                                            {app.approveTime && <span>审批时间：{app.approveTime}</span>}
                                                        </div>
                                                        {app.comment && (
                                                            <div className="mt-2 p-2 bg-slate-50 rounded-lg text-xs text-slate-600 flex items-start gap-2">
                                                                <MessageSquare size={14} className="text-slate-400 mt-0.5" />
                                                                <span>{app.comment}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    {app.status === 'pending' && (
                                                        <>
                                                            <button onClick={() => setModal({ open: true, type: 'approve', data: app })} className="px-4 py-2 bg-green-50 text-green-600 rounded-lg text-sm font-medium hover:bg-green-100 flex items-center gap-1">
                                                                <Check size={14} /> 通过
                                                            </button>
                                                            <button onClick={() => setModal({ open: true, type: 'reject', data: app })} className="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 flex items-center gap-1">
                                                                <X size={14} /> 拒绝
                                                            </button>
                                                        </>
                                                    )}
                                                    <button onClick={() => setModal({ open: true, type: 'view', data: app })} className="px-4 py-2 bg-slate-50 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-100 flex items-center gap-1">
                                                        <Eye size={14} /> 详情
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>

                    {/* 弹窗 */}
                    {modal.open && (
                        <Modal 
                            type={modal.type} 
                            data={modal.data} 
                            onClose={() => setModal({ open: false, type: '', data: null })}
                            onApprove={handleApprove}
                            onSubmit={handleNewApplication}
                        />
                    )}
                </div>
            );
        };

        const Modal = ({ type, data, onClose, onApprove, onSubmit }) => {
            const [comment, setComment] = useState('');
            const [form, setForm] = useState({ requestRoles: [], reason: '' });

            const handleRoleToggle = (role) => {
                setForm(prev => ({
                    ...prev,
                    requestRoles: prev.requestRoles.includes(role) ? prev.requestRoles.filter(r => r !== role) : [...prev.requestRoles, role]
                }));
            };

            const getTitle = () => {
                if (type === 'new') return '发起权限申请';
                if (type === 'approve') return '审批通过';
                if (type === 'reject') return '审批拒绝';
                return '申请详情';
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="text-lg font-bold text-slate-800">{getTitle()}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-400"><X size={20} /></button>
                        </div>
                        <div className="p-6 space-y-4">
                            {type === 'new' ? (
                                <>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-2">申请角色</label>
                                        <div className="flex flex-wrap gap-2">
                                            {ROLES.filter(r => r !== '超级管理员').map(role => (
                                                <button key={role} onClick={() => handleRoleToggle(role)} className={`px-3 py-1.5 rounded-lg text-xs font-medium border transition-all ${form.requestRoles.includes(role) ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-slate-50 text-slate-500 border-slate-200 hover:bg-slate-100'}`}>
                                                    {role}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-1">申请理由</label>
                                        <textarea value={form.reason} onChange={e => setForm({...form, reason: e.target.value})} rows={4} placeholder="请详细说明申请该权限的原因..." className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-100 outline-none resize-none" />
                                    </div>
                                </>
                            ) : type === 'view' ? (
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><div className="text-xs text-slate-400 mb-1">申请人</div><div className="font-medium">{data.applicant}</div></div>
                                        <div><div className="text-xs text-slate-400 mb-1">部门</div><div>{data.department}</div></div>
                                    </div>
                                    <div><div className="text-xs text-slate-400 mb-1">当前角色</div><div className="flex gap-1">{data.currentRoles.length > 0 ? data.currentRoles.map(r => <span key={r} className="px-2 py-0.5 bg-slate-100 text-slate-600 rounded text-xs">{r}</span>) : <span className="text-slate-400">无</span>}</div></div>
                                    <div><div className="text-xs text-slate-400 mb-1">申请角色</div><div className="flex gap-1">{data.requestRoles.map(r => <span key={r} className="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs">{r}</span>)}</div></div>
                                    <div><div className="text-xs text-slate-400 mb-1">申请理由</div><div className="p-3 bg-slate-50 rounded-lg text-sm">{data.reason}</div></div>
                                    {data.comment && <div><div className="text-xs text-slate-400 mb-1">审批意见</div><div className="p-3 bg-slate-50 rounded-lg text-sm">{data.comment}</div></div>}
                                </div>
                            ) : (
                                <>
                                    <div className="p-4 bg-slate-50 rounded-xl">
                                        <div className="text-sm text-slate-600 mb-2"><span className="font-medium">{data.applicant}</span> 申请角色：</div>
                                        <div className="flex gap-1">{data.requestRoles.map(r => <span key={r} className="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-medium">{r}</span>)}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-1">审批意见</label>
                                        <textarea value={comment} onChange={e => setComment(e.target.value)} rows={3} placeholder="请输入审批意见..." className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-100 outline-none resize-none" />
                                    </div>
                                </>
                            )}
                        </div>
                        <div className="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                            <button onClick={onClose} className="px-5 py-2 text-slate-600 text-sm font-medium hover:bg-white rounded-lg border border-slate-200">
                                {type === 'view' ? '关闭' : '取消'}
                            </button>
                            {type === 'new' && (
                                <button onClick={() => onSubmit(form)} disabled={form.requestRoles.length === 0 || !form.reason} className="px-5 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">提交申请</button>
                            )}
                            {type === 'approve' && (
                                <button onClick={() => onApprove(data.id, true, comment)} className="px-5 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 shadow-md">确认通过</button>
                            )}
                            {type === 'reject' && (
                                <button onClick={() => onApprove(data.id, false, comment)} className="px-5 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 shadow-md">确认拒绝</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
