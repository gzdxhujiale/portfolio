<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店铺经营仓</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { animation: { 'fade-in': 'fadeIn 0.3s ease-out' }, keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }, colors: { indigo: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5' } } } } }</script>
    <style>::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; } body { overflow-x: hidden; } .chart-hover-scale:hover { transform: scale(1.02); transition: transform 0.3s; cursor: pointer; }</style>
</head>
<body class="bg-[#F8FAFC]">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo } = React;
        
        // --- 1. 数据定义 (写死) ---
        const BASE_STORE_DATA = [
            { id: 1, name: '淘宝A店', platform: '淘宝', gmv: 450000, cost: 300000, grossMargin: 33.3, netMargin: 15.2, returnRate: 5.4, roi: 3.2, aov: 158, trend: 'up' },
            { id: 2, name: '抖音B店', platform: '抖音', gmv: 820000, cost: 550000, grossMargin: 32.9, netMargin: 12.8, returnRate: 8.2, roi: 2.8, aov: 89, trend: 'up' },
            { id: 3, name: '快手C店', platform: '快手', gmv: 320000, cost: 200000, grossMargin: 37.5, netMargin: 18.5, returnRate: 4.1, roi: 4.1, aov: 65, trend: 'down' },
            { id: 4, name: '淘宝B店', platform: '淘宝', gmv: 150000, cost: 110000, grossMargin: 26.6, netMargin: 8.5, returnRate: 6.2, roi: 2.1, aov: 120, trend: 'up' },
            { id: 5, name: '抖音A店', platform: '抖音', gmv: 1200000, cost: 880000, grossMargin: 26.6, netMargin: 10.5, returnRate: 9.5, roi: 2.5, aov: 92, trend: 'up' },
        ];

        // 模拟明细数据生成器
        const getDetailData = (name) => Array.from({length:5},(_,i)=>({
            id:i,
            date:`2025-10-0${i+1}`,
            desc:`${name} - 业务明细 ${i+1}`, 
            amount:Math.floor(Math.random()*50000)+1000
        }));

        // 模拟日维度订单明细数据
        const getDayOrderDetails = (storeName, date) => Array.from({length: 12}, (_, i) => ({
            id: `ORD-${20251000 + i}`,
            time: `${date} 10:${10+i}`,
            product: `商品示例-${String.fromCharCode(65+i)}`,
            amount: Math.floor(Math.random() * 200) + 50,
            status: ['已结算', '已发货', '退款中', '已结算'][i % 4]
        }));

        // 模拟商品财务详情数据
        const getProductFinanceDetails = (orderId) => ({
            id: orderId,
            productCode: `SKU-${orderId.split('-')[1] || '001'}-${String.fromCharCode(65 + Math.floor(Math.random() * 26))}`,
            productCost: (Math.random() * 40 + 20).toFixed(2), // 新增商品成本
            salesIncome: (Math.random() * 500 + 100).toFixed(2),
            otherIncome: (Math.random() * 20).toFixed(2),
            salesReturn: Math.random() > 0.8 ? (Math.random() * 50).toFixed(2) : '0.00',
            platformFee: (Math.random() * 30 + 5).toFixed(2),
            commission: (Math.random() * 50 + 10).toFixed(2),
            otherFee: (Math.random() * 10).toFixed(2)
        });

        // --- 图标 ---
        const IconWrapper = ({ children, size = 20, className = "", ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const FileSpreadsheet = (p) => <IconWrapper {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></IconWrapper>;
        const TrendingUp = (p) => <IconWrapper {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>;
        const TrendingDown = (p) => <IconWrapper {...p}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></IconWrapper>;
        const ShoppingBag = (p) => <IconWrapper {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></IconWrapper>;
        const ArrowRight = (p) => <IconWrapper {...p}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconWrapper>;
        const ArrowLeft = (p) => <IconWrapper {...p}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>;
        const BarChart2 = (p) => <IconWrapper {...p}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></IconWrapper>;
        const Activity = (p) => <IconWrapper {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const Package = (p) => <IconWrapper {...p}><line x1="16.5" x2="7.5" y1="9.4" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></IconWrapper>;
        const PieChart = (p) => <IconWrapper {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconWrapper>;
        const Calculator = (p) => <IconWrapper {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>;
        const X = (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const Tag = (p) => <IconWrapper {...p}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></IconWrapper>;
        const Calendar = (p) => <IconWrapper {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconWrapper>;
        const ChevronDown = (p) => <IconWrapper {...p}><path d="m6 9 6 6 6-6"/></IconWrapper>;
        const HelpCircle = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconWrapper>;

        // --- 组件 ---
        const safeLocaleString = (val) => (val !== undefined && val !== null) ? val.toLocaleString() : '0';

        // 数据来源提示组件
        const DataSourceTooltip = ({ source, className }) => {
            const [visible, setVisible] = useState(false);
            const sources = source.split(/[,\uff0c]+/).map(s => s.trim()); // 支持中英文逗号分割

            return (
                <span className={`relative inline-flex items-center ml-2 -top-0.5 ${className}`}>
                    <sup 
                        className="cursor-pointer text-slate-400 hover:text-indigo-500 transition-colors"
                        onClick={(e) => { e.stopPropagation(); setVisible(!visible); }}
                        title="点击查看数据来源"
                    >
                        <HelpCircle size={14} />
                    </sup>
                    {visible && (
                        <div className="absolute left-full top-0 ml-2 w-max max-w-[300px] bg-slate-800/95 backdrop-blur text-white text-xs px-3 py-2.5 rounded-xl shadow-xl z-[100] animate-fade-in text-left border border-slate-700" onClick={(e) => e.stopPropagation()}>
                            <div className="font-bold mb-1 opacity-50 text-[10px] uppercase tracking-wider">数据来源</div>
                            <div className="space-y-1">
                                {sources.map((s, i) => <div key={i} className="font-mono">{s}</div>)}
                            </div>
                            <div className="absolute left-0 top-2.5 -ml-1 w-2 h-2 bg-slate-800/95 border-l border-b border-slate-700 rotate-45"></div>
                        </div>
                    )}
                    {visible && (
                        <div className="fixed inset-0 z-[90] cursor-default" onClick={(e) => { e.stopPropagation(); setVisible(false); }}></div>
                    )}
                </span>
            );
        };

        const DetailRow = ({ label, value, isMoney, color = "text-slate-700" }) => (
            <div className="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
                <span className="text-slate-500 text-sm">{label}</span>
                <span className={`font-medium font-mono ${color}`}>{value}</span>
            </div>
        );

        // 年份选择器组件
        const YearSelector = ({ year, setYear }) => (
            <div className="relative">
                <select 
                    value={year} 
                    onChange={(e) => setYear(e.target.value)} 
                    className="appearance-none bg-transparent pl-3 pr-8 py-1 text-sm font-medium text-slate-700 focus:outline-none cursor-pointer hover:text-indigo-600 transition-colors"
                >
                    <option value="2025">2025年</option>
                    <option value="2024">2024年</option>
                    <option value="2023">2023年</option>
                </select>
                <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                    <ChevronDown size={14} />
                </div>
            </div>
        );

        // 图表组件 (ComboChart)
        const ComboChart = ({ onMonthClick, onDayClick, isMonthlyView, viewMode = 'scale' }) => {
            const [hoveredItem, setHoveredItem] = useState(null);
            const count = isMonthlyView ? 30 : 12;
            
            const data = useMemo(() => Array.from({ length: count }, (_, i) => {
                const baseOrders = Math.floor(Math.random() * 2000) + 1000;
                return { 
                    label: isMonthlyView ? `${i+1}日` : `${i+1}月`,
                    income: Math.floor(Math.random()*40000)+60000, 
                    cost: Math.floor(Math.random()*20000)+30000, 
                    profit: Math.floor(Math.random()*15000)+10000,
                    roi: (Math.random()*2+1.5).toFixed(2), 
                    aov: Math.floor(Math.random()*50)+100,
                    orders: baseOrders,
                    refundBefore: Math.floor(baseOrders * 0.05),
                    shipped: Math.floor(baseOrders * 0.95),
                    refundAfter: Math.floor(baseOrders * 0.03),
                    settled: Math.floor(baseOrders * 0.90)
                };
            }), [count, isMonthlyView]);

            const h = 280; const w = 800; const p = 40; const xStep = (w - p * 2) / (count - 1);
            
            const getMaxVal = () => {
                if (viewMode === 'scale') return 120000;
                if (viewMode === 'efficiency') return 5; 
                if (viewMode === 'order') return 4000;
                return 100;
            };
            const maxVal = getMaxVal();
            const getY = (val, max = maxVal) => h - p - (val / max) * (h - p * 2);
            
            const handleClick = (label) => {
                if (!isMonthlyView && onMonthClick) onMonthClick(label);
                else if (isMonthlyView && onDayClick) onDayClick(label);
            };

            const renderLine = (key, color, strokeWidth = 2, strokeDasharray = "") => (
                <polyline 
                    points={data.map((d, i) => `${p + i * xStep},${getY(d[key], viewMode==='efficiency' && key==='aov' ? 300 : maxVal)}`).join(' ')} 
                    fill="none" stroke={color} strokeWidth={strokeWidth} strokeDasharray={strokeDasharray} className="pointer-events-none" 
                />
            );

            return (
                <div className="w-full overflow-x-auto">
                    <div className="min-w-[600px] relative">
                        <svg viewBox={`0 0 ${w} ${h}`} className="w-full h-auto" onMouseLeave={() => setHoveredItem(null)}>
                            <line x1={p} y1={h - p} x2={w - p} y2={h - p} stroke="#e2e8f0" />
                            <line x1={p} y1={p} x2={w - p} y2={p} stroke="#e2e8f0" strokeDasharray="4 4" />
                            {hoveredItem !== null && <line x1={p + hoveredItem * xStep} y1={p} x2={p + hoveredItem * xStep} y2={h - p} stroke="#cbd5e1" strokeDasharray="2 2" strokeWidth="1"/>}
                            
                            {viewMode === 'scale' && (
                                <>
                                    {data.map((d, i) => (
                                        <g key={i} onClick={() => handleClick(d.label)} className="cursor-pointer" onMouseEnter={() => setHoveredItem(i)}>
                                            <rect x={p + i * xStep - (isMonthlyView?3:8)} y={getY(d.profit*3)} width={isMonthlyView?6:16} height={(h - p) - getY(d.profit*3)} fill="#10b981" opacity={hoveredItem===i?0.8:0.3} rx="2"/>
                                            <rect x={p + i * xStep - xStep/2} y={p} width={xStep} height={h-p} fill="transparent" />
                                        </g>
                                    ))}
                                    {renderLine('income', '#6366f1')}
                                    {renderLine('cost', '#ef4444')}
                                </>
                            )}

                            {viewMode === 'efficiency' && (
                                <>
                                    {data.map((d, i) => (
                                        <g key={i} onClick={() => handleClick(d.label)} className="cursor-pointer" onMouseEnter={() => setHoveredItem(i)}>
                                            <rect x={p + i * xStep - (isMonthlyView?3:8)} y={getY(d.aov, 300)} width={isMonthlyView?6:16} height={(h - p) - getY(d.aov, 300)} fill="#f59e0b" opacity={hoveredItem===i?0.8:0.3} rx="2"/>
                                            <rect x={p + i * xStep - xStep/2} y={p} width={xStep} height={h-p} fill="transparent" />
                                        </g>
                                    ))}
                                    {renderLine('roi', '#8b5cf6', 3)}
                                </>
                            )}

                            {viewMode === 'order' && (
                                <>
                                    {data.map((d, i) => (
                                        <g key={i} onClick={() => handleClick(d.label)} className="cursor-pointer" onMouseEnter={() => setHoveredItem(i)}>
                                            <rect x={p + i * xStep - xStep/2} y={p} width={xStep} height={h-p} fill="transparent" />
                                            <circle cx={p + i * xStep} cy={getY(d.orders)} r={hoveredItem===i?4:2} fill="#3b82f6" className="pointer-events-none"/>
                                        </g>
                                    ))}
                                    {renderLine('orders', '#3b82f6', 2)} 
                                    {renderLine('shipped', '#64748b', 2)}
                                    {renderLine('settled', '#10b981', 2)}
                                    {renderLine('refundBefore', '#f59e0b', 2, "4 2")}
                                    {renderLine('refundAfter', '#ef4444', 2, "4 2")}
                                </>
                            )}

                            {data.map((d, i) => {
                                if (isMonthlyView && i % 5 !== 0 && i !== count - 1 && hoveredItem !== i) return null;
                                return <text key={i} x={p + i * xStep} y={h - 10} fontSize="10" textAnchor="middle" fill={hoveredItem===i ? "#475569" : "#94a3b8"} fontWeight={hoveredItem===i?"bold":"normal"}>{d.label}</text>
                            })}
                        </svg>
                        
                        {hoveredItem !== null && (
                            <div className="absolute bg-white p-3 rounded-xl shadow-xl border border-slate-100 text-xs pointer-events-none z-30 animate-fade-in" style={{ left: `${(p + hoveredItem * xStep) / w * 100}%`, top: '5%', transform: 'translateX(-50%)', minWidth: '150px' }}>
                                <div className="font-bold mb-2 border-b pb-1">{data[hoveredItem].label} 数据详情</div>
                                {viewMode === 'scale' && (
                                    <div className="space-y-1">
                                        <div className="flex justify-between text-indigo-600"><span>收入</span><span>¥{data[hoveredItem].income}</span></div>
                                        <div className="flex justify-between text-red-500"><span>成本</span><span>¥{data[hoveredItem].cost}</span></div>
                                        <div className="flex justify-between text-emerald-600 font-bold"><span>毛利</span><span>¥{data[hoveredItem].profit * 3}</span></div>
                                    </div>
                                )}
                                {viewMode === 'efficiency' && (
                                    <div className="space-y-1">
                                        <div className="flex justify-between text-violet-600 font-bold"><span>ROI</span><span>{data[hoveredItem].roi}</span></div>
                                        <div className="flex justify-between text-amber-600"><span>客单价</span><span>¥{data[hoveredItem].aov}</span></div>
                                    </div>
                                )}
                                {viewMode === 'order' && (
                                    <div className="space-y-1">
                                        <div className="flex justify-between text-blue-600 font-bold"><span>订单数</span><span>{data[hoveredItem].orders}</span></div>
                                        <div className="flex justify-between text-slate-500"><span>发货数</span><span>{data[hoveredItem].shipped}</span></div>
                                        <div className="flex justify-between text-emerald-600"><span>结算数</span><span>{data[hoveredItem].settled}</span></div>
                                        <div className="border-t border-dashed pt-1 mt-1">
                                            <div className="flex justify-between text-amber-500"><span>发货前退款</span><span>{data[hoveredItem].refundBefore}</span></div>
                                            <div className="flex justify-between text-red-500"><span>发货后退款</span><span>{data[hoveredItem].refundAfter}</span></div>
                                        </div>
                                    </div>
                                )}
                                {isMonthlyView && <div className="mt-2 text-[10px] text-slate-400 text-center bg-slate-50 py-0.5 rounded">点击查看当日单据</div>}
                            </div>
                        )}
                    </div>
                    
                    <div className="flex justify-center gap-4 text-xs mt-2 pb-2 flex-wrap">
                        {viewMode === 'scale' && <><span className="flex items-center gap-1"><div className="w-3 h-1 bg-indigo-500 rounded"></div> 收入</span><span className="flex items-center gap-1"><div className="w-3 h-1 bg-red-500 rounded"></div> 成本</span><span className="flex items-center gap-1"><div className="w-3 h-3 bg-emerald-400 opacity-30 rounded"></div> 毛利</span></>}
                        {viewMode === 'efficiency' && <><span className="flex items-center gap-1"><div className="w-3 h-1 bg-violet-500 rounded"></div> ROI</span><span className="flex items-center gap-1"><div className="w-3 h-3 bg-amber-500 opacity-50 rounded"></div> 客单价</span></>}
                        {viewMode === 'order' && (
                            <>
                                <span className="flex items-center gap-1"><div className="w-3 h-1 bg-blue-500 rounded"></div> 订单数</span>
                                <span className="flex items-center gap-1"><div className="w-3 h-1 bg-slate-500 rounded"></div> 发货数</span>
                                <span className="flex items-center gap-1"><div className="w-3 h-1 bg-emerald-500 rounded"></div> 结算数</span>
                                <span className="flex items-center gap-1"><div className="w-3 h-1 bg-amber-500 border-b border-amber-500 border-dashed h-0"></div> 发货前退</span>
                                <span className="flex items-center gap-1"><div className="w-3 h-1 bg-red-500 border-b border-red-500 border-dashed h-0"></div> 发货后退</span>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const InteractivePieChart = ({ data, onClick }) => {
            const [hoveredIndex, setHoveredIndex] = useState(null);
            let cumulativePercent = 0;
            const getCoordinates = (percent) => [Math.cos(2 * Math.PI * percent), Math.sin(2 * Math.PI * percent)];
            return (
                <div className="flex items-center justify-center gap-6 h-40">
                    <div className="w-32 h-32 relative shrink-0"><svg viewBox="-1.2 -1.2 2.4 2.4" style={{ transform: 'rotate(-90deg)' }}>
                        {data.map((slice, i) => {
                            const [sx, sy] = getCoordinates(cumulativePercent);
                            cumulativePercent += slice.percent;
                            const [ex, ey] = getCoordinates(cumulativePercent);
                            const largeArc = slice.percent > 0.5 ? 1 : 0;
                            return <path key={i} d={`M 0 0 L ${sx} ${sy} A 1 1 0 ${largeArc} 1 ${ex} ${ey} Z`} fill={slice.color} stroke="white" strokeWidth="0.05" className="transition-transform duration-300 cursor-pointer" style={{ transform: hoveredIndex === i ? 'scale(1.1)' : 'scale(1)' }} onMouseEnter={() => setHoveredIndex(i)} onMouseLeave={() => setHoveredIndex(null)} onClick={(e) => { e.stopPropagation(); onClick && onClick(slice); }}/>
                        })}
                        <circle cx="0" cy="0" r="0.6" fill="white" className="pointer-events-none"/>
                    </svg></div>
                    <div className="flex-1 space-y-2 text-xs">{data.map((slice, i) => <div key={i} className={`flex justify-between px-2 py-1 rounded cursor-pointer ${hoveredIndex === i ? 'bg-slate-50 scale-105' : ''}`} onMouseEnter={() => setHoveredIndex(i)} onMouseLeave={() => setHoveredIndex(null)} onClick={(e) => { e.stopPropagation(); onClick && onClick(slice); }}><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{ backgroundColor: slice.color }}></div><span className="text-slate-500">{slice.label}</span></div><span className="font-bold">{(slice.percent * 100).toFixed(0)}%</span></div>)}</div>
                </div>
            );
        };

        const App = () => {
            const [storeOverviewState, setStoreOverviewState] = useState({ view: 'annual', month: null });
            const [storeDetailState, setStoreDetailState] = useState(null);
            const [overviewViewMode, setOverviewViewMode] = useState('scale');
            const [detailViewMode, setDetailViewMode] = useState('scale');
            const [detailModalItem, setDetailModalItem] = useState(null);
            const [metricDetailModal, setMetricDetailModal] = useState(null);
            const [dayDetailModal, setDayDetailModal] = useState(null);
            const [productDetailModal, setProductDetailModal] = useState(null); 
            const [selectedYear, setSelectedYear] = useState('2025'); // 新增：年份状态

            const handleBackdropClick = (e, setter) => { if (e.target === e.currentTarget) setter(null); };

            const getMetrics = (state) => {
                const seed = (state && state.view === 'monthly' ? state.month.length : 0) + parseInt(selectedYear); // 将年份加入种子
                return {
                    gmv: state && state.view === 'monthly' ? 250000 + seed * 10000 : 2940000 + seed * 10000,
                    grossMargin: (31.4 + (seed % 5)).toFixed(1) + '%', netMargin: (13.0 - (seed % 3)).toFixed(1) + '%', returnRate: '6.7%',
                    roi: 3.2, aov: 120,
                    costPie: [{ label: '商品', percent: 0.45, color: '#6366f1' }, { label: '物流', percent: 0.25, color: '#3b82f6' }, { label: '营销', percent: 0.20, color: '#f59e0b' }, { label: '人力', percent: 0.10, color: '#cbd5e1' }],
                    subjectPie: [{ label: '主营收入', percent: 0.60, color: '#10b981' }, { label: '其他收入', percent: 0.15, color: '#34d399' }, { label: '服务费', percent: 0.15, color: '#6ee7b7' }, { label: '营业外', percent: 0.10, color: '#a7f3d0' }]
                };
            };
            const currentOverviewMetrics = useMemo(() => getMetrics(storeOverviewState), [storeOverviewState, selectedYear]);
            const currentDetailMetrics = useMemo(() => getMetrics(storeDetailState), [storeDetailState, selectedYear]);
            const currentStoreList = useMemo(() => BASE_STORE_DATA.map(s => ({
                ...s, 
                gmv: (storeOverviewState.view==='monthly'?Math.floor(s.gmv/12):s.gmv) + (parseInt(selectedYear) % 2020) * 1000 // 模拟年份影响
            })), [storeOverviewState, selectedYear]);

            // 获取图表数据来源
            const getChartSource = (m) => {
                if (m === 'scale') return "dws_transaction_summary";
                if (m === 'efficiency') return "dws_transaction_summary, dws_allocated_costs, dws_internal_trade";
                if (m === 'order') return "stg_onlines_transactions, dwd_income, dwd_transcation_costs";
                return "";
            };

            // 获取明细弹窗数据来源
            const getDetailSource = (name) => {
                const map = {
                    '商品': 'dwd_goods_costs',
                    '物流': 'dwd_general_expenses',
                    '营销': 'dwd_transaction_costs',
                    '人力': 'dwd_payroll'
                };
                // 如果是成本构成里的项
                if (map[name]) return map[name];
                // 否则默认是科目构成（收入类）
                return "dwd_income";
            };

            const MetricCards = ({ data }) => (
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div className="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg cursor-pointer hover:shadow-xl transition-all active:scale-95" onClick={() => setMetricDetailModal({title: '总 GMV', formula: '∑(各渠道销售额) - 取消订单金额', items:[{name:'淘宝',val:'¥120k'},{name:'抖音',val:'¥90k'}]})}><div className="flex items-center gap-3 mb-2 opacity-90"><ShoppingBag size={20}/><span>{storeDetailState ? '当前 GMV' : '总 GMV'}</span></div><div className="text-2xl font-bold">¥ {data.gmv.toLocaleString()}</div></div>
                    <div className="bg-white border rounded-2xl p-6 shadow-sm cursor-pointer hover:border-indigo-300 active:scale-95" onClick={() => setMetricDetailModal({title: '平均毛利率', formula: '(收入-成本)/收入', items:[{name:'收入',val:'¥100k'},{name:'成本',val:'¥68k'}]})}><div className="flex items-center gap-3 mb-2 text-slate-500"><TrendingUp size={18} className="text-emerald-500"/><span>平均毛利率</span></div><div className="text-2xl font-bold text-slate-800">{data.grossMargin}</div></div>
                    <div className="bg-white border rounded-2xl p-6 shadow-sm cursor-pointer hover:border-indigo-300 active:scale-95" onClick={() => setMetricDetailModal({title: '平均净利率', formula: '(毛利-费用)/收入', items:[{name:'毛利',val:'¥32k'},{name:'费用',val:'¥20k'}]})}><div className="flex items-center gap-3 mb-2 text-slate-500"><TrendingUp size={18} className="text-emerald-500"/><span>平均净利率</span></div><div className="text-2xl font-bold text-slate-800">{data.netMargin}</div></div>
                    <div className="bg-white border rounded-2xl p-6 shadow-sm cursor-pointer hover:border-indigo-300 active:scale-95" onClick={() => setMetricDetailModal({title: '平均退货率', formula: '退货数/发货数', items:[{name:'发货',val:'1000'},{name:'退货',val:'67'}]})}><div className="flex items-center gap-3 mb-2 text-slate-500"><TrendingDown size={18} className="text-amber-500"/><span>平均退货率</span></div><div className="text-2xl font-bold text-slate-800">{data.returnRate}</div></div>
                </div>
            );

            const Charts = ({ prefix, data, state, onMonth, mode, setMode, onDayClick }) => (
                <div className="space-y-6">
                    {state.view === 'monthly' && <div className="flex items-center gap-2 mb-4"><button onClick={()=>onMonth(null)} className="flex items-center gap-1 text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100"><ArrowLeft size={16}/> 返回年度概览</button><span className="text-slate-400">|</span><span className="font-bold text-slate-600">{state.month} 经营详情</span></div>}
                    <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                        <div className="flex justify-between mb-6">
                            <h4 className="font-bold text-slate-800 flex items-center gap-2">
                                {mode==='scale'?<BarChart2 size={18} className="text-indigo-500"/>:mode==='order'?<Package size={18} className="text-blue-500"/>:<Activity size={18} className="text-violet-500"/>} 
                                {prefix}趋势 
                                <DataSourceTooltip source={getChartSource(mode)} />
                            </h4>
                            <div className="flex bg-slate-100 p-1 rounded-lg"><button onClick={()=>setMode('scale')} className={`px-3 py-1 text-xs rounded ${mode==='scale'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>收支</button><button onClick={()=>setMode('efficiency')} className={`px-3 py-1 text-xs rounded ${mode==='efficiency'?'bg-white shadow text-violet-600':'text-slate-500'}`}>效率</button><button onClick={()=>setMode('order')} className={`px-3 py-1 text-xs rounded ${mode==='order'?'bg-white shadow text-blue-600':'text-slate-500'}`}>业务量</button></div>
                        </div>
                        <ComboChart isMonthlyView={state.view==='monthly'} onMonthClick={onMonth} onDayClick={onDayClick} viewMode={mode} />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm"><h4 className="font-bold mb-4 text-slate-700">成本构成</h4><InteractivePieChart data={data.costPie} onClick={i=>setDetailModalItem({name:i.label})}/></div>
                        <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm"><h4 className="font-bold mb-4 text-slate-700">科目构成</h4><InteractivePieChart data={data.subjectPie} onClick={i=>setDetailModalItem({name:i.label})}/></div>
                    </div>
                </div>
            );

            return (
                <div className="p-8 max-w-7xl mx-auto animate-fade-in">
                    {/* 顶部标题和筛选器 */}
                    <div className="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 flex items-center">
                                店铺经营仓
                                <DataSourceTooltip source="ads_shop_summary" />
                            </h2>
                            <p className="text-slate-500 text-sm mt-1">多平台店铺经营数据深度分析</p>
                        </div>
                        <div className="flex items-center gap-4 bg-white p-2 rounded-xl border border-slate-100 shadow-sm">
                            <div className="flex items-center gap-2 px-2 text-slate-600 text-sm"><Calendar size={16} className="text-indigo-500"/><span className="font-medium">报表年度:</span></div>
                            <div className="relative">
                                <select value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)} className="appearance-none bg-transparent pl-3 pr-8 py-1 text-sm font-medium text-slate-700 focus:outline-none cursor-pointer hover:text-indigo-600 transition-colors">
                                    <option value="2025">2025年</option>
                                    <option value="2024">2024年</option>
                                    <option value="2023">2023年</option>
                                </select>
                                <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg></div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-[2rem] shadow-sm border border-slate-100 p-8">
                        <MetricCards data={currentOverviewMetrics} />
                        <div className="border border-slate-200 rounded-xl overflow-hidden mb-8"><table className="w-full text-sm"><thead className="bg-slate-50 text-slate-500"><tr><th className="px-6 py-4 text-left">店铺</th><th className="px-6 py-4 text-left">平台</th><th className="px-6 py-4 text-right">GMV</th><th className="px-6 py-4 text-right">成本</th><th className="px-6 py-4 text-right">毛利率</th><th className="px-6 py-4 text-right">净利率</th><th className="px-6 py-4 text-right bg-indigo-50/30">ROI</th><th className="px-6 py-4 text-right bg-indigo-50/30">客单价</th><th className="px-6 py-4 text-center">趋势</th></tr></thead><tbody className="divide-y">{currentStoreList.map(s=><tr key={s.id} className="hover:bg-indigo-50 cursor-pointer" onClick={()=>setStoreDetailState({store:s, view:'annual', month:null})}><td className="px-6 py-4 font-bold text-slate-700 flex items-center gap-2">{s.name}<ArrowRight size={14} className="text-indigo-300"/></td><td className="px-6 py-4">{s.platform}</td><td className="px-6 py-4 text-right font-medium">¥ {s.gmv.toLocaleString()}</td><td className="px-6 py-4 text-right text-slate-500">¥ {s.cost.toLocaleString()}</td><td className="px-6 py-4 text-right text-emerald-600">{s.grossMargin}%</td><td className="px-6 py-4 text-right text-indigo-600 font-bold">{s.netMargin}%</td><td className="px-6 py-4 text-right text-amber-600 bg-indigo-50/30">{s.returnRate}%</td><td className="px-6 py-4 text-right font-bold text-violet-600 bg-indigo-50/30">{s.roi}</td><td className="px-6 py-4 text-right text-slate-700 bg-indigo-50/30">¥ {s.aov}</td><td className="px-6 py-4 text-center">{s.trend==='up'?<TrendingUp size={16} className="text-emerald-500 inline"/>:<TrendingDown size={16} className="text-red-500 inline"/>}</td></tr>)}</tbody></table></div>
                        <Charts 
                            prefix="全店" 
                            data={currentOverviewMetrics} 
                            state={storeOverviewState} 
                            onMonth={m=>setStoreOverviewState(p=>({...p, view:m?'monthly':'annual', month:m}))} 
                            mode={overviewViewMode} 
                            setMode={setOverviewViewMode}
                            onDayClick={(day) => setDayDetailModal({title: `全店 - ${day}`, day})} 
                        />
                    </div>

                    {storeDetailState && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/20 backdrop-blur-sm animate-fade-in" onClick={(e) => handleBackdropClick(e, setStoreDetailState)}>
                            <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[95vh]" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        {storeDetailState.view==='monthly' ? <button onClick={()=>setStoreDetailState(p=>({...p, view:'annual', month:null}))} className="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100"><ArrowLeft size={20}/></button> : <div className="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center"><ShoppingBag size={20}/></div>}
                                        <div>
                                            <h3 className="text-xl font-bold text-slate-800 flex items-center">
                                                {storeDetailState.store.name} {storeDetailState.view==='monthly'&&<span className="px-2 py-0.5 rounded bg-indigo-100 text-indigo-600 text-xs ml-2">{storeDetailState.month}</span>}
                                                <DataSourceTooltip source="dws_transaction_summary, dws_allocated_costs, dws_internal_trade" />
                                            </h3>
                                            <p className="text-sm text-slate-500">经营深度分析</p>
                                        </div>
                                    </div>
                                    <button onClick={()=>setStoreDetailState(null)} className="p-2 hover:bg-slate-100 rounded-full"><X size={22}/></button>
                                </div>
                                <div className="p-8 overflow-y-auto bg-slate-50/50">
                                    <MetricCards data={currentDetailMetrics} />
                                    <Charts 
                                        prefix="" 
                                        data={currentDetailMetrics} 
                                        state={storeDetailState} 
                                        onMonth={m=>setStoreDetailState(p=>({...p, view:m?'monthly':'annual', month:m}))} 
                                        mode={detailViewMode} 
                                        setMode={setDetailViewMode}
                                        onDayClick={(day) => setDayDetailModal({title: `${storeDetailState.store.name} - ${day}`, day})}
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 日维度业务明细弹窗 */}
                    {dayDetailModal && (
                         <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-slate-900/20 backdrop-blur-sm animate-fade-in" onClick={(e) => handleBackdropClick(e, setDayDetailModal)}>
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b flex justify-between items-center">
                                    <div><h3 className="text-xl font-bold text-slate-800">{dayDetailModal.title} 业务明细</h3></div>
                                    <button onClick={()=>setDayDetailModal(null)} className="p-2 hover:bg-slate-100 rounded-full"><X size={20}/></button>
                                </div>
                                <div className="overflow-y-auto p-0">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-50 text-slate-500 sticky top-0 z-10 shadow-sm"><tr><th className="px-6 py-3 text-left">订单号</th><th className="px-6 py-3 text-left">时间</th><th className="px-6 py-3 text-left">商品信息</th><th className="px-6 py-3 text-left">状态</th><th className="px-6 py-3 text-right">金额</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {getDayOrderDetails('store', dayDetailModal.day).map((order, i) => (
                                                <tr key={i} className="hover:bg-slate-50 cursor-pointer" onClick={() => setProductDetailModal(getProductFinanceDetails(order.id))}>
                                                    <td className="px-6 py-3 font-mono text-slate-500">{order.id}</td>
                                                    <td className="px-6 py-3 text-slate-500">{order.time}</td>
                                                    <td className="px-6 py-3 font-medium text-slate-700">{order.product}</td>
                                                    <td className="px-6 py-3"><span className={`px-2 py-0.5 rounded text-xs ${order.status==='已结算'?'bg-emerald-100 text-emerald-700':order.status==='退款中'?'bg-red-100 text-red-700':'bg-slate-100 text-slate-600'}`}>{order.status}</span></td>
                                                    <td className="px-6 py-3 text-right font-medium">¥ {order.amount}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="p-4 border-t bg-slate-50 text-right"><button onClick={()=>setDayDetailModal(null)} className="px-4 py-2 bg-white border rounded-lg text-sm text-slate-600 hover:bg-slate-100">关闭</button></div>
                            </div>
                        </div>
                    )}

                    {/* 新增：商品财务详情弹窗 */}
                    {productDetailModal && (
                        <div className="fixed inset-0 z-[90] flex items-center justify-center p-4 bg-slate-900/30 backdrop-blur-sm animate-fade-in" onClick={(e) => handleBackdropClick(e, setProductDetailModal)}>
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b flex justify-between items-center">
                                    <div className="flex items-center gap-2">
                                        <Tag size={20} className="text-indigo-500"/>
                                        <div><h3 className="text-xl font-bold text-slate-800">订单明细</h3><p className="text-xs text-slate-500">订单号: {productDetailModal.id}</p></div>
                                    </div>
                                    <button onClick={()=>setProductDetailModal(null)} className="p-2 hover:bg-slate-100 rounded-full"><X size={20}/></button>
                                </div>
                                <div className="p-6 grid gap-4">
                                   <DetailRow label="商品编码" value={productDetailModal.productCode} />
                                   <DetailRow label="商品成本" value={`¥ ${productDetailModal.productCost}`} color="text-slate-500" />
                                   <div className="h-px bg-slate-100 my-1"></div>
                                   <DetailRow label="销售收入" value={`¥ ${productDetailModal.salesIncome}`} color="text-emerald-600" />
                                   <DetailRow label="营业外收入" value={`¥ ${productDetailModal.otherIncome}`} color="text-emerald-600" />
                                   <div className="h-px bg-slate-100 my-1"></div>
                                   <DetailRow label="销售退回" value={`- ¥ ${productDetailModal.salesReturn}`} color="text-red-500" />
                                   <DetailRow label="平台服务费" value={`- ¥ ${productDetailModal.platformFee}`} color="text-amber-600" />
                                   <DetailRow label="佣金" value={`- ¥ ${productDetailModal.commission}`} color="text-amber-600" />
                                   <DetailRow label="其它销售收费" value={`- ¥ ${productDetailModal.otherFee}`} color="text-amber-600" />
                                   
                                   <div className="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
                                        <span className="font-bold text-slate-700">实际结算金额</span>
                                        <span className="text-xl font-bold text-indigo-600 font-mono">
                                            ¥ {(parseFloat(productDetailModal.salesIncome) + parseFloat(productDetailModal.otherIncome) - parseFloat(productDetailModal.salesReturn) - parseFloat(productDetailModal.platformFee) - parseFloat(productDetailModal.commission) - parseFloat(productDetailModal.otherFee)).toFixed(2)}
                                        </span>
                                   </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {detailModalItem && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/20 backdrop-blur-sm animate-fade-in" onClick={(e) => handleBackdropClick(e, setDetailModalItem)}>
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between mb-4">
                                    <h3 className="text-lg font-bold flex items-center">
                                        {detailModalItem.name} - 明细
                                        <DataSourceTooltip source={getDetailSource(detailModalItem.name)} />
                                    </h3>
                                    <button onClick={()=>setDetailModalItem(null)}><X size={20}/></button>
                                </div>
                                <div className="space-y-2">{[1,2,3].map(i=><div key={i} className="flex justify-between p-2 bg-slate-50 rounded text-sm"><span>明细项 {i}</span><span>¥ {(Math.random()*5000).toFixed(0)}</span></div>)}</div>
                            </div>
                        </div>
                    )}
                    
                    {metricDetailModal && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-slate-900/20 backdrop-blur-sm animate-fade-in" onClick={(e) => handleBackdropClick(e, setMetricDetailModal)}>
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="bg-indigo-600 p-6 text-white"><h3 className="text-xl font-bold flex items-center gap-2"><Calculator size={20}/> {metricDetailModal.title}</h3><p className="text-indigo-100 text-xs mt-2 bg-indigo-700/30 p-2 rounded">公式: {metricDetailModal.formula}</p></div>
                                <div className="p-6 space-y-3">{metricDetailModal.items.map((item,i)=><div key={i} className="flex justify-between border-b pb-2 last:border-0"><span className="text-slate-600\">{item.name}</span><span className="font-bold font-mono\">{item.val}</span></div>)}</div>
                                <div className="p-4 bg-slate-50 text-right"><button onClick={()=>setMetricDetailModal(null)} className="px-4 py-2 bg-white border rounded text-sm hover:bg-slate-100">关闭</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>